

# ðŸ¢ Slack Office Booking Bot

A robust, interactive Slackbot designed to manage office desk bookings. This application allows employees to book specific desks for specific dates, view who is coming into the office, and receive automated daily summaries.

## ðŸŒŸ Features

* **Visual Desk Selection:** Users can view an office floor plan (image) and select their seat.
* **Dynamic Configuration:** Desk numbers are generated programmatically (via a loop). To adapt this to your office, simply change the desk count variable in `db_client.py`.
* **Conflict Prevention:** Ensures a user cannot book multiple desks for the same day, and prevents double-booking of the same desk.
* **Live Dashboard:** Sends a message every weekday at 6:00 PM showing who is coming the next workday. This message updates in real-time as users book via the "Book" button attached to the message.

---

## ðŸ› ï¸ 1. Database Setup (Supabase)

This project uses **Supabase** (PostgreSQL) for data storage.

### Prerequisites

1. Create a project at [supabase.com](https://supabase.com).
2. Go to **Project Settings -> API**.
3. Copy the following keys for your `.env` file later:
* **Project URL**
* **service_role secret** (Do not use the public/anon key, as the bot needs write access).



### SQL Setup

Go to the **SQL Editor** in Supabase and run the following script to create the necessary tables:

```sql
-- 1. Table for Desk Bookings
CREATE TABLE bookings (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id TEXT NOT NULL,         -- Slack User ID
    desk_id TEXT NOT NULL,         -- Desk Name (e.g., Desk 1)
    booking_date DATE NOT NULL,    -- YYYY-MM-DD
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    
    -- Constraint: A desk can only be booked once per day
    CONSTRAINT unique_desk_date UNIQUE (desk_id, booking_date)
);

-- 2. Table for Daily Dashboard Messages (to allow real-time updates)
CREATE TABLE daily_messages (
    target_date DATE PRIMARY KEY,  -- The date the dashboard refers to
    channel_id TEXT NOT NULL,
    message_ts TEXT NOT NULL       -- Slack Message Timestamp ID
);

-- 3. Enable Row Level Security (RLS) & Access
ALTER TABLE bookings ENABLE ROW LEVEL SECURITY;
ALTER TABLE daily_messages ENABLE ROW LEVEL SECURITY;

-- Allow the bot (service_role) full access
CREATE POLICY "Enable access for service role" ON bookings FOR ALL TO service_role USING (true) WITH CHECK (true);
CREATE POLICY "Enable access for service role" ON daily_messages FOR ALL TO service_role USING (true) WITH CHECK (true);

```

---

## âš™ï¸ 2. Slack App Configuration

You need to configure the bot in the [Slack API Dashboard](https://api.slack.com/apps).

### A. Create the App

1. Click **Create New App** -> **From Scratch**.
2. Name it (e.g., "OfficeBot") and select your workspace.

### B. Slash Commands

Go to **Slash Commands** and create the following:

| Command | Request URL | Description |
| --- | --- | --- |
| `/book` | `http://YOUR_SERVER_IP:3000/slack/interactions` | Open booking modal |
| `/delete` | `http://YOUR_SERVER_IP:3000/slack/interactions` | Manage your bookings |
| `/who_is_in_the_house` | `http://YOUR_SERVER_IP:3000/slack/interactions` | See list of colleagues |

### C. Interactivity

1. Go to **Interactivity & Shortcuts**.
2. Toggle **On**.
3. **Request URL:** `http://YOUR_SERVER_IP:3000/slack/interactions` (Same as above).

### D. OAuth & Permissions

1. Go to **OAuth & Permissions**.
2. Scroll to **Scopes** -> **Bot Token Scopes**. Add:
* `chat:write` (To send messages)
* `commands` (To receive slash commands)


3. Scroll up to **OAuth Tokens for Your Workspace** and copy the **Bot User OAuth Token** (`xoxb-...`).

---

## ðŸ“² 3. Installation & Channel Setup

### Install App

1. In the Slack Dashboard, go to **Install App**.
2. Click **Install to Workspace** and authorize.

### Add to Channel

1. Create a channel for notifications (e.g., `#office-status`).
2. Invite the bot to the channel: type `/invite @OfficeBot`.

### Get Channel ID

The bot needs the ID of this channel to send the daily scheduled messages.

1. Right-click the channel name in the sidebar.
2. Select **Copy Link**.
3. The ID is the last part of the URL (e.g., `C012345ABCD`).

---

## ðŸš€ 4. Server Deployment & Operations

This guide assumes a Linux server (Ubuntu/Debian).

### Environment Setup

1. Navigate to your project folder:
```bash
cd /path/to/slackbot

```


2. Create `.env` file:
```ini
SLACK_BOT_TOKEN=xoxb-....
SLACK_CHANNEL_ID=C0.......
SUPABASE_URL=https://.......supabase.co
SUPABASE_KEY=ey....... (service_role)
OPENAI_API_KEY=sk-...... (Optional, for AI messages)
PORT=3000

```


3. Install dependencies:
```bash
pip install -r requirements.txt

```



### Running with Gunicorn (The Web Server)

We use **Gunicorn** instead of `python app.py` for production. Gunicorn is a WSGI server that can handle multiple concurrent requests efficiently.

* **Workers (`-w 2`):** Allows the bot to handle multiple users clicking buttons simultaneously without freezing.
* **Binding (`-b`):** Exposes the app to the internet.

### Daemonizing with Systemd (Auto-start)

To ensure the bot runs in the background and restarts automatically if the server reboots:

1. Create a service file:
```bash
sudo nano /etc/systemd/system/slackbot.service

```


2. Paste the configuration (Update paths/user accordingly):
```ini
[Unit]
Description=Slack Office Bot Gunicorn Service
After=network.target

[Service]
User=root
Group=root
WorkingDirectory=/home/your_username/slackbot
Environment="PATH=/home/your_username/slackbot/.venv/bin"
ExecStart=/home/your_username/slackbot/.venv/bin/gunicorn -w 2 -b 0.0.0.0:3000 app:app
Restart=always

[Install]
WantedBy=multi-user.target

```


3. Start the service:
```bash
sudo systemctl daemon-reload
sudo systemctl enable slackbot
sudo systemctl start slackbot

```


4. Check status: `sudo systemctl status slackbot`

### Scheduling (Cron)

We use Linux **Crontab** to trigger the evening announcement (Mon-Fri at 18:00).

1. Create a shell script wrapper (`run_announcement.sh`) in your project folder:
```bash
#!/bin/bash
cd /home/your_username/slackbot
source .venv/bin/activate
python3 scheduler.py

```


*Make it executable: `chmod +x run_announcement.sh*`
2. Edit Crontab:
```bash
crontab -e

```


3. Add this line to run at 6:00 PM on weekdays:
```bash
0 18 * * 1-5 /home/your_username/slackbot/run_announcement.sh >> /home/your_username/slackbot/cron.log 2>&1

```



---

## ðŸ“‚ File Structure

* `app.py`: The main Flask server (handles Slack interactions, modals, buttons).
* `db_client.py`: Handles all Supabase database operations.
* `scheduler.py`: The script that sends the daily dashboard message.
* `run_announcement.sh`: Shell script to trigger the scheduler via Cron.
* `requirements.txt`: Python dependencies.
* `.env`: Configuration secrets.
